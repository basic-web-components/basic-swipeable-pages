<!--
Let the user swipe horizontally with swipe gesture or mouse.
-->

<link rel="import" href="../basic-spread/basic-spread.html">

<polymer-element name="basic-swipeable-pages">
<template>
  <style>
  :host {
    background: #f8f8f8;
    display: block;
    height: 300px;
    overflow: hidden;
    width: 100%;
    /* max-width: 400px; */
  }

  #swipeContainer {
    display: -webkit-flex;
    display: flex;
    height: 300px;
    touch-action: none;
    width: 300%;
  }

  #swipeContainer.snapping {
    -webkit-transition: -webkit-transform 0.2s cubic-bezier(.48,0,.88,1.48);
    transition: transform 0.2s cubic-bezier(.48,0,.88,1.48);  /* was ease-out */
  }

  polyfill-next-selector {
    content: '#swipeContainer > *';
  }
  ::content > * {
    width: 100%;
    touch-action: none;
  }
  </style>
  <div id="swipeContainer">
    <content></content>
  </div>
</template>
<script>
Polymer({

  ready: function() {
    this.addEventListener('touchstart', function(event) {
      this._showTransition(false);
      this._startX = event.changedTouches[0].clientX;
      this._previousX = this._startX;
      event.preventDefault();
    }.bind(this));
    this.addEventListener('touchmove', function(event) {
      this._trackTo(event.changedTouches[0].clientX);
      event.preventDefault();
    }.bind(this));
    this.addEventListener('touchend', function() {
      this._trackTo(event.changedTouches[0].clientX);
      this.snap();
      event.preventDefault();
    })
  },

  snap: function() {
    var width = this.offsetWidth;
    var offset = this._offset;
    // Handle mod of a negative number.
    var edgeX = ((offset % width) + width) % width;
    var snapLeft = (edgeX < width / 2);
    var delta = snapLeft ? -edgeX : (width - edgeX);
    this._showTransition(true);
    this._panTo(offset + delta);
  },

  _panTo: function(x) {
    var count = this.children.length;
    var maxOffset = (count - 1) * this.offsetWidth;
    x = Math.max(Math.min(x, 0), -maxOffset);
    var transform = 'translateX(' + x + 'px)';
    this.$.swipeContainer.style.webkitTransform = transform;      
    this.$.swipeContainer.style.transform = transform;
    this._offset = x;
  },

  _trackTo: function(x) {
    var deltaX = this._previousX ? x - this._previousX : 0;
    this._panTo(this._offset + deltaX);
    this._previousX = x;    
  },

  _showTransition: function(on) {
    this.$.swipeContainer.classList.toggle('snapping', on);
  },

  _offset: 0

});
</script>
</polymer-element>
